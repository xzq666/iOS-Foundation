##  AVFoundation入门


### 概述

AVFoundation是可以用来播放和创建基于时间的视听媒体的框架，它提供了基于时间的视听数据的详细界面上的OC接口，可以用它来检查、创建、编辑、重新编码媒体文件，也可以从设备得到输入流和实时捕捉回放并在过程中操控视频。

AVFoundation充分利用了多核硬件的优势并大量使用block和GCD机制将复杂的计算进程放在后台线程运行。自动提供硬件加速操作，确保在大部分设备上应用程序都能以最佳性能运行。


### 适用范围

AVFoundation的几个最主要的支撑框架及其提供的功能如下：

1、Core Audio
OSX和iOS上处理所有音频事件的框架，是由多个框架整合在一起的总称。为音频和MIDI内容的录制、播放和处理提供相应接口，也提供高层级的接口，比容通过Audio Queue Services框架所提供的那些接口，主要处理基本的音频播放和录音相关功能。也提供相对低层级的接口。

2、Core Video
针对数字视频所提供的管道模式，为其相对的Core Media提供图片缓存和缓存池支持，提供了一个能够对数字视频逐帧访问的接口。该框架通过像素格式之间的转换并管理视频同步事项使得复杂的工作得到了有效简化。

3、Core Media
低层级媒体管道的一部分，它提供对音频样本和视频帧处理所需的低层级数据类型和接口，还提供了AVFoundation用到的基于CMTime数据类型的时基模型。CMTime及其相关数据类型一般在AVFoundation处理基于时间的操作时使用。

4、Core Animation
合成及动画相关框架。主要功能是提供苹果平台所具有的美观、流畅的动画s效果。提供一个简单、声明性编程模式，并已经封装了支持OpenGL和OpenGL ES功能的基于OC的各种类。使用Core Animation时，对于视频内容的播放和视频捕捉这两个动作，AVFoundation还可以利用Core Animation在视频编辑和播放过程中添加动画标题和图片效果。

AVFoundation处于高层级框架和低层级框架之间，提供了很多低层级框架才能实现的功能和性能，并且是以更简单的OC接口方式实现，同时也可以和高层级框架无缝连接。


### 功能分解

1、音频播放和记录。播放音频文件使用AVAudioPlayer，录制音频文件使用AVAudioRecorder，并使用AVAudioSession来配置应用程序的音频行为。
2、媒体文件检查。提供检查正在使用的媒体文件的功能。可以查看媒体资源信息，比如是否可以回放、编辑、导出等。可以获取相关技术参数，比如内容持续时间，创建日期、播放音量等，此外还基于AVMetadataItem类提供功能强大的元数据支持。允许开发者读取关于媒体资源的描述信息。
3、视频播放。AVFoundation提供可以播放从本地或者远程流中获取的视频资源，并对视频播放和内容的展示进行控制。核心类是AVPlayer和AVPlayerItem，此外还可以整合其他更高级的功能，如控制子标题和章节信息等。
4、媒体捕捉。核心类是AVCaptureSession，作为所有活动的汇集点来接受摄像头设备由各路流返过来的电影和图片。是用来管理数据捕捉的中央协调对象，可以使用一个实例来协调从AVFoundation输入设备到输出的数据流。
5、媒体编辑。对媒体资源的整合和编辑提供了强有力的支持。允许修改和编辑独立的媒体片段、随时修改音视频文件的参数以及添加动画标题和场景切换效果。
6、媒体处理。当需要执行更高级的媒体处理任务是，可以用AVAssetReader和AVAssetWriter类来实现这些功能。这些类提供了直接访问视频帧和音频样本的功能，可以对媒体资源进行任何更高级的处理。


### 数字媒体

帧率：视频文件一秒内所能展现的帧数视频的帧率，单位FPS。常见的帧率有24FPS、25FPS、30FPS。
目前视频最流行的宽高比是16:9，即每16个水平像素对应9个垂直像素。常见视频尺寸为1280x720，1920x1080。
如果每个像素点使用8位RGB色彩空间，这意味着红色8位，绿色8位，蓝色8位。那么一个帧率为30FPS，分辨率是1920x1080的视频存储需求就是：1920x1080x 30x24 (b/s)。


### 数字媒体压缩

1、色彩二次抽样
视频数据可以使用YCbCr颜色模式，也常称为YUV。对RGB模式来说，每个像素是由红、绿、蓝三种颜色组合而成，而YUV使用的是色彩通道UV(颜色)替换了像素的亮度通道Y(亮度)。
眼睛对于亮度的敏感度要高于颜色，所以可以大幅度减少存储在每个像素中的颜色信息，不至于使图片质量严重受损，减少颜色数据的过程称为色彩二次抽样。

2、编解码器压缩
大部分音视频都是使用编解码器(codec)来压缩的，即编码器和解码器(encoder/decoder)。编解码器使用高级压缩算法对需要保存或发送的音视频数据进行压缩和编码，同时还可以将压缩文件解码成为适合播放和编辑的媒体资源。编解码器可以进行无损压缩也可以进行有损压缩。

3、视频编解码器
对于视频编解码而言，AVFoundation提供有限的编解码器集合，只提供苹果公司认定的最主流的几种媒体类型的支持。对视频文件主要可以归结为H.264和Apple ProRes。
H.264规范是Motion Picture Experts Group(MPEG)所定义的MPEG-4的一部分，
H.264遵循早期的MPEG-1和MPEG-2标准，但在以更低比特率得到更高图片质量方面有了长足进步，使其更好地使用流媒体文件和移动设备及视频摄像头。
空间上：压缩独立视频帧，称为帧内压缩。通过消除包含在每个独立视频帧内的色彩及结构中的冗余信息来进行压缩，因此可在不降低图片质量的情况小尽可能缩小尺寸。这类压缩类似JEPG压缩，帧内压缩可以作为有损压缩算法，通常用于对原始图片的一部分进行处理以生成极高质量的照片，通过这一过程创建的帧成为I-frames。
时间上：通过以组为单位的视频帧压缩冗余数据，称为帧间压缩。很多帧被组合在一起成为一组图片(简称GOP)，对于GOP所存在的时间维度的冗余可以被消除。在一个时间维度上的冗余，如视频的固定背景环境，就可以通过压缩的方式进行消除。

